<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Cr√©dito Amortizado</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7fa;
      color: #333;
      padding: 2rem;
      max-width: 1000px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
      color: #2c3e50;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, button, select {
      padding: 0.5rem;
      margin-top: 0.2rem;
      font-size: 1rem;
      width: 100%;
      max-width: 300px;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      font-size: 0.9rem;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th {
      background: #2c3e50;
      color: white;
      padding: 0.6rem;
    }
    td {
      padding: 0.5rem;
      text-align: right;
    }
    .resumen {
      margin-top: 2rem;
      background: #ecf0f1;
      padding: 1rem;
      border-radius: 8px;
    }
    .abonos {
      background: #e3f2fd;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
    .btn {
      margin-top: 1rem;
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      padding: 0.6rem 1rem;
      border-radius: 6px;
    }
    .btn:hover {
      background: #2980b9;
    }
    .abono-list li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>

  <h1>Calculadora de Cr√©dito Amortizado</h1>

  <div class="form-group">
    <label>Monto del Cr√©dito:</label>
    <input type="number" id="monto" placeholder="Ej. 100000" />
  </div>
  <div class="form-group">
    <label>Tasa de Inter√©s Anual (%):</label>
    <input type="number" id="tasa" step="0.01" placeholder="Ej. 12.5" />
  </div>
  <div class="form-group">
    <label>Plazo (meses):</label>
    <input type="number" id="plazo" placeholder="Ej. 36" />
  </div>

  <div class="abonos">
    <h3>Abonos Extraordinarios</h3>
    <label>Mes del Abono:</label>
    <input type="number" id="mesAbono" placeholder="Ej. 5" />
    <label>Monto del Abono:</label>
    <input type="number" id="montoAbono" placeholder="Ej. 10000" />
    <button class="btn" onclick="agregarAbono()">Agregar Abono</button>
    <ul id="listaAbonos" class="abono-list"></ul>
  </div>

  <button class="btn" onclick="calcularAmortizacion()">Calcular Amortizaci√≥n</button>

  <div class="resumen" id="resumen"></div>

  <div id="tabla"></div>

  <button class="btn" onclick="descargarExcel()">üì• Descargar Excel</button>
  <button class="btn" onclick="descargarPDF()">üìÑ Descargar PDF</button>

  <script>
    let abonos = [];

    function agregarAbono() {
      const mes = parseInt(document.getElementById('mesAbono').value);
      const monto = parseFloat(document.getElementById('montoAbono').value);
      if (mes && monto && mes > 0 && monto > 0) {
        abonos.push({ mes, monto });
        mostrarAbonos();
        document.getElementById('mesAbono').value = '';
        document.getElementById('montoAbono').value = '';
      }
    }

    function eliminarAbono(index) {
      abonos.splice(index, 1);
      mostrarAbonos();
    }

    function mostrarAbonos() {
      const lista = document.getElementById('listaAbonos');
      lista.innerHTML = '';
      abonos.forEach((abono, index) => {
        const li = document.createElement('li');
        li.innerHTML = `Mes ${abono.mes}: $${abono.monto.toFixed(2)} <button onclick="eliminarAbono(${index})">‚ùå</button>`;
        lista.appendChild(li);
      });
    }

    let datosTabla = [];

    function calcularAmortizacion() {
      const montoInicial = parseFloat(document.getElementById('monto').value);
      const tasaAnual = parseFloat(document.getElementById('tasa').value);
      const plazo = parseInt(document.getElementById('plazo').value);

      const tasaMensual = tasaAnual / 12 / 100;
      const cuota = montoInicial * (tasaMensual / (1 - Math.pow(1 + tasaMensual, -plazo)));

      let saldo = montoInicial;
      let totalIntereses = 0;
      let totalCapital = 0;
      datosTabla = [];

      let tablaHTML = `
        <table>
          <thead>
            <tr>
              <th>Mes</th>
              <th>Pago Mensual</th>
              <th>Inter√©s</th>
              <th>Capital</th>
              <th>Abono Extra</th>
              <th>Saldo</th>
            </tr>
          </thead>
          <tbody>
      `;

      let mes = 1;
      while (saldo > 0.01 && mes <= 600) {
        const interes = saldo * tasaMensual;
        let capital = cuota - interes;
        if (capital > saldo) capital = saldo;
        saldo -= capital;
        totalIntereses += interes;
        totalCapital += capital;

        const abonoExtra = abonos.find(a => a.mes === mes);
        let abono = 0;
        let abonoTexto = '-';
        if (abonoExtra) {
          abono = Math.min(abonoExtra.monto, saldo);
          saldo -= abono;
          totalCapital += abono;
          abonoTexto = `$${abono.toFixed(2)}`;
        }

        datosTabla.push([mes, cuota.toFixed(2), interes.toFixed(2), capital.toFixed(2), abono.toFixed(2), saldo.toFixed(2)]);

        tablaHTML += `
          <tr>
            <td>${mes}</td>
            <td>$${cuota.toFixed(2)}</td>
            <td>$${interes.toFixed(2)}</td>
            <td>$${capital.toFixed(2)}</td>
            <td>${abonoTexto}</td>
            <td>$${saldo > 0 ? saldo.toFixed(2) : '0.00'}</td>
          </tr>
        `;

        mes++;
        if (saldo <= 0.01) break;
      }

      tablaHTML += '</tbody></table>';
      document.getElementById('tabla').innerHTML = tablaHTML;

      document.getElementById('resumen').innerHTML = `
        <h3>Resumen Ejecutivo</h3>
        <p><strong>Plazo Liquidado:</strong> ${mes - 1} meses</p>
        <p><strong>Total Pagado:</strong> $${(totalIntereses + totalCapital).toFixed(2)}</p>
        <p><strong>Total Abonado a Capital:</strong> $${totalCapital.toFixed(2)}</p>
        <p><strong>Total Intereses Pagados:</strong> $${totalIntereses.toFixed(2)}</p>
      `;
    }

    function descargarExcel() {
      if (datosTabla.length === 0) return alert("Primero calcula la amortizaci√≥n.");

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([
        ["Mes", "Pago Mensual", "Inter√©s", "Capital", "Abono Extra", "Saldo"],
        ...datosTabla
      ]);
      XLSX.utils.book_append_sheet(wb, ws, "Amortizaci√≥n");
      XLSX.writeFile(wb, "tabla_amortizacion.xlsx");
    }

    async function descargarPDF() {
      if (datosTabla.length === 0) return alert("Primero calcula la amortizaci√≥n.");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text("Resumen Ejecutivo", 14, 15);
      const resumen = document.getElementById("resumen").innerText.split("\n");
      resumen.forEach((line, i) => {
        doc.text(line, 14, 25 + i * 6);
      });

      doc.text("Tabla de Amortizaci√≥n", 14, 60);
      let y = 70;
      doc.setFontSize(10);
      doc.text("Mes | Mensual | Inter√©s | Capital | Extra | Saldo", 14, y);
      datosTabla.forEach((fila, i) => {
        y += 6;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
        doc.text(fila.join(" | "), 14, y);
      });

      doc.save("tabla_amortizacion.pdf");
    }
  </script>

</body>
</html>
